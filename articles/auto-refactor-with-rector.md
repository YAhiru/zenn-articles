---
title: "Rector で始める自動リファクタリング入門"
emoji: "🍖"
type: "tech"
topics: ["php", "rector"] # タグ。["markdown", "rust", "aws"]のように指定する
published: false
---

# 書くこと

- 通常の使い方
- PHP7.4 未満のクラスにタイプドプロパティを導入するデモ
- カスタムルールの作り方
- test から始まるテストメソッドをアノテーション方式に変えるデモ
- カスタムルールのテストの仕方
- 用意されているヘルパーの紹介
- 自分でカスタムルールを作るときのコツ

# はじめに

みなさん、コードの改善はしていますでしょうか。
コードの改善と一口に言っても様々な性格のものが存在しますが、その中でもある一定のルールに基づく機械的な作業が要求されるものがあるかと思います。

例えば、

- 全ての関数 A を関数 B に変えたい
- クラス A を継承している全てのクラスの親クラスをクラス B に変えたい
- コンストラクタ内でインスタンス化している処理を DI パターンに変えたい

などなど……。

小規模なものであれば手作業でおこなっても問題のないことが多いですが、大規模になるとうっかりミスが発生しがちだったり単純作業ゆえの精神的な苦痛が伴うこともあったりなど、あまり好ましくありません。

これから紹介する Rector は、そういった機械的な作業からエンジニアを開放するとてもすごいツールです。

是非この記事で Rector の基本的な使い方を覚え、日々の業務を楽にしてみてください。

# サンプルプロジェクトの構築

この記事では予め用意されたサンプルコードに対して Rector を実際に実行することで理解を深めていきたいと思います。

## 推奨環境

- PHP >=7.3

## git clone

作業ディレクトリから以下のコマンドを実行しサンプルプロジェクトをローカル環境に構築します。

```bash
$ git clone git@github.com:YAhiru/rector-tutorial.git
$ cd rector-tutorial
$ composer i
```

## サンプルプロジェクトの確認

サンプルプロジェクトは以下の構成になっています。

```
.
├── rector    # Rector 用のディレクトリ
│   ├── src   # 記事の終盤で作成するカスタムルール用のディレクトリ
│   └── tests # カスタムルールのテストディレクトリ
├── src       # サンプルのアプリケーションコードディレクトリ
└── tests     # サンプルのアプリケーションコードのテストディレクトリ
```

理由は後述しますが Rector 用のディレクトリとサンプルのアプリケーションコードを分けています。

サンプルのアプリケーションコードとは Web アプリケーションであればコントローラーやエンティティなどに当たるもので、リファクタリングの対象となるコードです。
今回は src ディレクトリに単純なクラスを 1 つだけ用意しています。

rector ディレクトリはこの記事の後半で実装するカスタムルールのためのディレクトリとなっていますので、最低限の設定のみで残りはほぼ空の状態となっています。

# インストール

- composer, docker, phar の 3 種類があることを紹介
- サンプルプロジェクトのサブディレクトリに Rector を composer でインストールする

# 予め用意されているルールを適用してみる

- 既存のクラスをタイプドプロパティにする。
- オプションでルールを指定して実行
- その他に使えるルールの探し方を紹介する

# カスタムルールを作る

- テストの作り方を紹介する
- test から始まるテストメソッドをアノテーション形式に変えるカスタムルールを実際に作る。
- テストが通ることを確認する

# カスタムルールを実行する

- config の書き方を紹介する
- config を元に rector を実行する

# カスタムルールを作る際のコツ

- やりたい内容に近いことを行っている既存のルールのコードを読むことが手取り早い
