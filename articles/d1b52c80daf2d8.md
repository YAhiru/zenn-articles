---
title: "Terraform ã ã‘ã§ ECS ã‚¿ã‚¹ã‚¯ã‚’æ¥­å‹™æ™‚é–“å¤–ã¯åœæ­¢ã•ã›ã‚‹ï¼"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "ECS", "Terraform", "Fargate"]
published: false
publication_name: "stafes_blog"
---

ã“ã®è¨˜äº‹ã¯[ã‚¹ã‚¿ãƒ¼ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ« Advent Calendar 2022](https://qiita.com/advent-calendar/2022/stafes) 4 æ—¥ç›®ã®è¨˜äº‹ã§ã™

https://qiita.com/advent-calendar/2022/stafes

---

# ã¯ã˜ã‚ã«

2022 å¹´ã¯å††å®‰ã®å½±éŸ¿ã‚‚ã‚ã‚Š AWS ã®ã‚³ã‚¹ãƒˆãŒä»Šã¾ã§ä»¥ä¸Šã«ä¸ŠãŒã£ã¦ã—ã¾ã„ã¾ã—ãŸã­
ãã®å½±éŸ¿ã‚‚ã‚ã‚Šã€åƒ•ãŒæ‰€å±ã—ã¦ã„ã‚‹ã‚¹ã‚¿ãƒ¼ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ã§ã¯ AWS ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®æ©Ÿé‹ãŒé«˜ã¾ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸ
ã‚¤ãƒ³ãƒ•ãƒ©ã‚ˆãã‚ã‹ã‚‰ã‚“å‹¢ã®åƒ•ã§ã™ãŒã€å°‘ã—ã§ã‚‚ã‚³ã‚¹ãƒˆå‰Šæ¸›ã«å”åŠ›ã—ãŸã„ï¼ã¨ã„ã†ã“ã¨ã§åƒ•ãŒæ‹…å½“ã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(Fargate)ã‚’æ¥­å‹™æ™‚é–“å¤–ã¯è‡ªå‹•ã§åœæ­¢ã•ã›ã‚‹ã¨ã„ã†ã“ã¨ã‚’ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸï¼

ã—ã‹ã—ã€ã„ã–èª¿ã¹ã¦ã¿ã‚‹ã¨ Lambda ã‚’ä½œã‚‰ãªã„ã¨ã„ã‘ãªã„ãªã©å°‘ã—æ‰‹é–“ãŒã‹ã‹ã‚‹ã‚„ã‚Šæ–¹ãŒå¤šãã€ã‚‚ã†å°‘ã—æ¥½ã«ã‚„ã‚ŠãŸã„ï¼ã¨ãªã£ã¦ã—ã¾ã£ãŸã®ã§ã“ã®è¨˜äº‹ã§ã¯ãã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ï¼

# ã‚„ã‚Šæ–¹

AWS ã«ã¯ ECS ã‚¿ã‚¹ã‚¯ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’ä»»æ„ã®æ™‚é–“ã«å®Ÿè¡Œã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™

https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/ec2-auto-scaling-scheduled-scaling.html

ã“ã®ä»•çµ„ã¿ã‚’ä½¿ã£ã¦æ¥­å‹™ã®çµ‚äº†æ™‚é–“ã« ECS ã‚¿ã‚¹ã‚¯ã‚’ 0 å€‹ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³ã—æ¥­å‹™ã®é–‹å§‹æ™‚é–“ã« n å€‹ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã™ã‚Œã° Lambda ãªã©ã‚’ä½œã‚‰ãšã«æ¸ˆã‚€ã®ã§ã¯ã¨è€ƒãˆã¾ã—ãŸ

ã“ã®æ–¹æ³•ã§ã¯ã€terraform ä¸Šã§æ–°ãŸã« `aws_appautoscaling_target` ã¨ `aws_appautoscaling_scheduled_action` ã‚’æ‰±ã†ã ã‘ã§æ¸ˆã¿ã¾ã™
ãã®ãŸã‚ã€Lambda ãªã©ã‚’ä½œæˆã›ãšã« terraform ã‚’ã¡ã‚‡ã£ã¨ã„ã˜ã‚‹ã ã‘ã§å®Œçµã™ã‚‹ã“ã¨ãŒã§ãã€ã¨ã¦ã‚‚æ¥½ã§ã™ï¼

## aws_appautoscaling_target

~~æ­£ç›´ã‚ã¾ã‚Šã‚ã‹ã£ã¦ãªã„ã§ã™ãŒ~~ ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®å¯¾è±¡ã¨ãªã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã§ã™

https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/appautoscaling_target

## aws_appautoscaling_scheduled_action

ã“ã®ãƒªã‚½ãƒ¼ã‚¹ã§ã¯ä½•æ™‚ã«ã©ã‚“ãªã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’ã™ã‚‹ã‹ã¨ã„ã£ãŸå®šç¾©ã‚’è¡Œãˆã¾ã™

https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/appautoscaling_scheduled_action

ä»Šå›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯

- æ¥­å‹™çµ‚äº†æ™‚é–“ã«ã‚¿ã‚¹ã‚¯æ•°ã‚’ 0 ã«ã—
- æ¥­å‹™é–‹å§‹æ™‚é–“ã«ã‚¿ã‚¹ã‚¯æ•°ã‚’å…ƒã«æˆ»ã™

ã¨ã„ã† 2 ã¤ã® `aws_appautoscaling_scheduled_action` ã‚’ä½œæˆã™ã‚Œã°è‰¯ã„ã“ã¨ã«ãªã‚Šã¾ã™

## ã‚³ãƒ¼ãƒ‰ä¾‹

ãã‚Œã§ã¯å®Ÿéš›ã«æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’è‹¥å¹²æ”¹å¤‰ã—ã¦ç´¹ä»‹ã—ã¾ã™

```tf
locals {
  # for_eachã§å›ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€åœæ­¢ã•ã›ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®å¢—æ¸›ã«æ‰‹è»½ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«
  ecs_services = {
    # åŒã˜ã‚µãƒ¼ãƒ“ã‚¹ãŒé‡è¤‡ã—ã¦å­˜åœ¨ã—ãªã„ã‚ˆã†ã€ã‚µãƒ¼ãƒ“ã‚¹åã‚’ã‚­ãƒ¼ã«ã—ã¦ã„ã‚‹
    # (ã‚¯ãƒ©ã‚¹ã‚¿ã‚’è·¨ã’ã°åŒã˜ã‚µãƒ¼ãƒ“ã‚¹åãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šãˆã‚‹ãŒã€å¼Šç¤¾ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å‘½åè¦å‰‡çš„ã«ã‚ã‚Šãˆãªã„ãŸã‚ã“ã‚“ãªæ„Ÿã˜ã«)
    "${aws_ecs_service.foo-service.name}" = {
      cluster      = aws_ecs_cluster.foo-cluster.name
      max_capacity = 2
      min_capacity = 1
    }
    # ...
  }
}

# ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã® aws_appautoscaling_target ã‚’ä½œæˆ
resource "aws_appautoscaling_target" "down-ecs-appautoscaling-target" {
  for_each = local.ecs_services

  max_capacity       = each.value.max_capacity
  min_capacity       = each.value.min_capacity
  resource_id        = "service/${each.value.cluster}/${each.key}"
  scalable_dimension = "ecs:service:DesiredCount"
  service_namespace  = "ecs"
}

# ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«22æ™‚ã«ãªã£ãŸã‚‰ã‚¿ã‚¹ã‚¯æ•°ã‚’0ã«ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚€
# å¼Šç¤¾ã¯ã‚³ã‚¢ã‚¿ã‚¤ãƒ ãªã—ã®ãƒ•ãƒ«ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãªã®ã§22æ™‚ã¾ã§åƒã„ã¦ã„ã„ã®ã ã€‚æœãŒå¼±ã„äººã§ã‚‚å®‰å¿ƒï¼
resource "aws_appautoscaling_scheduled_action" "down-ecs-task-scheduled-action" {
  for_each = local.ecs_services

  name               = "${each.key}-down"
  service_namespace  = aws_appautoscaling_target.down-ecs-appautoscaling-target[each.key].service_namespace
  resource_id        = aws_appautoscaling_target.down-ecs-appautoscaling-target[each.key].resource_id
  scalable_dimension = aws_appautoscaling_target.down-ecs-appautoscaling-target[each.key].scalable_dimension
  schedule           = "cron(0 22 ? * * *)"
  timezone           = "Asia/Tokyo"

  scalable_target_action {
    min_capacity = 0
    max_capacity = 0
  }
}

# ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«æœ5æ™‚ã«ãªã£ãŸã‚‰ã‚¿ã‚¹ã‚¯æ•°ã‚’å…ƒã«æˆ»ã™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚€
# æ—©ãå‡ºç¤¾ã—ã¦æ˜¼éãã«é€€å‹¤ã™ã‚‹ã¨1æ—¥ãŒã‚ã¡ã‚ƒé•·ãæ„Ÿã˜ã‚‹ã®ã§ã‚ªã‚¹ã‚¹ãƒ¡ï¼
resource "aws_appautoscaling_scheduled_action" "up-ecs-task-scheduled-action" {
  for_each = local.ecs_services

  name               = "${each.key}-up"
  service_namespace  = aws_appautoscaling_target.down-ecs-appautoscaling-target[each.key].service_namespace
  resource_id        = aws_appautoscaling_target.down-ecs-appautoscaling-target[each.key].resource_id
  scalable_dimension = aws_appautoscaling_target.down-ecs-appautoscaling-target[each.key].scalable_dimension
  schedule           = "cron(0 5 ? * * *)"
  timezone           = "Asia/Tokyo"

  scalable_target_action {
    max_capacity = each.value.max_capacity
    min_capacity = each.value.min_capacity
  }
}
```

# ãŠã‚ã‚Šã«

ã“ã®è¨˜äº‹ã§ã¯ Terraform ã ã‘ã§ ECS ã‚¿ã‚¹ã‚¯ã‚’å¢—æ¸›ã•ã›ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸ
å†’é ­ã§ã‚‚è»½ãè§¦ã‚Œã¾ã—ãŸãŒã€åƒ•è‡ªèº«ã¯ AWS ã«ãã“ã¾ã§è©³ã—ããªã„ãŸã‚ã€ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ãŒã‚ã‚‹å ´åˆã¯æ˜¯éæ•™ãˆã¦ãã ã•ã„ï¼

ã¾ãŸæœ€è¿‘æ–°ãŸã«å¼Šç¤¾ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºéƒ¨ã® Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã§ããŸã®ã§ã€ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã¿ã¦ãã ã•ã„ï¼
https://twitter.com/stafes_tech
